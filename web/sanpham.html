<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>S·∫£n ph·∫©m - Pet's Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* T√îNG M√ÄU T∆Ø∆†I S√ÅNG: XANH NG·ªåC & V√ÄNG N·∫ÆNG */
        :root {
            --primary-color: #00b894; /* Xanh Ng·ªçc (Mint/Aqua) */
            --secondary-color: #ffc34d; /* V√†ng N·∫Øng (Sunlight Yellow) */
            --text-color: #2d3436; /* X√°m ƒê·∫≠m cho ch·ªØ */
            --bg-light: #f1f8ff; /* N·ªÅn Navbar/Header */
        }
        body { 
            background: #f7f9fb; 
            color: var(--text-color);
        }
        .navbar { 
            background: var(--bg-light); 
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
            border-bottom: 3px solid var(--primary-color);
        }
        .navbar-brand, .nav-link { color: var(--text-color) !important; }

        /* Ti√™u ƒë·ªÅ ch√≠nh */
        .page-title { 
            color: var(--primary-color);
            font-weight: 700;
        }

        /* KH·ªêI L·ªåC NGANG */
        .filter-bar {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .form-select-sm { width: auto; display: inline-block; }

        /* Style Card S·∫£n ph·∫©m */
        .product-card{
            border: none; 
            border-radius:12px;
            box-shadow:0 6px 18px rgba(0,0,0,.05); 
            transition: all .3s;
            overflow: hidden; 
        }
        .product-card:hover{box-shadow:0 8px 20px rgba(0,0,0,.15); transform: translateY(-3px);} 
        .product-card .img-wrap{height:180px; overflow:hidden;}
        .product-card img{width:100%; height:100%; object-fit:cover; transition:transform .5s;}
        .product-card:hover img{transform:scale(1.08)} 
        .product-price { color: var(--primary-color); font-size: 1.1rem; }
        
        /* Footer */
        footer { 
            background: var(--secondary-color); 
            color: var(--text-color);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">üêæ Pet's Home</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item"><a class="nav-link" href="index.html">Trang ch·ªß</a></li>
                <li class="nav-item"><a class="nav-link fw-bold" href="sanpham.html">S·∫£n ph·∫©m</a></li>
                <li class="nav-item"><a class="nav-link" href="giohang.html">Gi·ªè h√†ng</a></li>
                <li class="nav-item"><a class="nav-link" href="donhang.html">ƒê∆°n h√†ng</a></li>

                <li class="nav-item d-none" id="navCustomers"><a class="nav-link" href="khachhang.html">Kh√°ch h√†ng</a></li>
                <li class="nav-item d-none" id="navAdmin"><a class="nav-link" href="quantri.html">Qu·∫£n tr·ªã</a></li>

                <li class="nav-item" id="navLogin"><a class="nav-link" href="index.html">ƒêƒÉng nh·∫≠p</a></li>

                <li class="nav-item dropdown d-none" id="navUser">
                    <a class="nav-link dropdown-toggle" href="#" id="navUserName" role="button" data-bs-toggle="dropdown">T√†i kho·∫£n</a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="donhang.html">ƒê∆°n h√†ng c·ªßa t√¥i</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="PetShop.logout(); location.href='index.html';">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-5">
    <h3 class="page-title mb-4">Kh√°m ph√° S·∫£n ph·∫©m cho th√∫ c∆∞ng</h3>

    <div class="filter-bar d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            
            <span class="small fw-bold text-muted">B·ªò L·ªåC:</span>
            
            <select id="filterCategory" class="form-select form-select-sm" onchange="renderProducts()">
                <option value="">Danh m·ª•c</option>
            </select>

            <select id="filterTarget" class="form-select form-select-sm" onchange="renderProducts()">
                <option value="">ƒê·ªëi t∆∞·ª£ng</option>
                <option value="Ch√≥">Ch√≥</option>
                <option value="M√®o">M√®o</option>
                <option value="Kh√°c">Kh√°c</option>
            </select>
            
            <input type="number" id="minPrice" class="form-control form-control-sm" style="width: 100px;" placeholder="Gi√° t·ª´" onkeyup="renderProducts()">
            <input type="number" id="maxPrice" class="form-control form-control-sm" style="width: 100px;" placeholder="Gi√° ƒë·∫øn" onkeyup="renderProducts()">
            
            <button class="btn btn-sm" onclick="renderProducts()" style="background:var(--primary-color); color:white; font-weight:bold;">L·ªçc</button>
        </div>

        <div>
             <span class="small fw-bold text-muted me-2">S·∫Øp x·∫øp:</span>
             <select id="filterSort" class="form-select form-select-sm" onchange="renderProducts()">
                <option value="default">M·∫∑c ƒë·ªãnh</option>
                <option value="price_asc">Gi√° tƒÉng d·∫ßn</option>
                <option value="price_desc">Gi√° gi·∫£m d·∫ßn</option>
             </select>
        </div>
    </div>
    <div class="row g-4" id="productList">
        <div class="col-12"><div class="alert alert-info text-center">ƒêang t·∫£i s·∫£n ph·∫©m...</div></div>
    </div>

</div>

<footer class="text-center py-3" style="background: var(--secondary-color); color: var(--text-color);">
    ¬© 2025 Pet's Home. All rights reserved üêæ
</footer>

<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const getLS = (key, defaultValue) => PetShop.getLS ? PetShop.getLS(key, defaultValue) : defaultValue;

    // L·∫•y query parameter 'q' t·ª´ URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialKeyword = urlParams.get('q') || '';
    
    // Kh·ªüi t·∫°o c√°c c·ªù quy·ªÅn h·∫°n cho Staff/Admin
    const flags = PetShop.getUIFlags ? PetShop.getUIFlags() : { canViewStock: false, showBuyPrice: false };
    const showStock = flags.canViewStock;
    const showBuyPrice = flags.showBuyPrice;

    document.addEventListener('DOMContentLoaded', function(){
        populateFilters();
        renderProducts();
    });

    // ===== LOGIC L·ªåC D·ªÆ LI·ªÜU =====
    function populateFilters() {
        const products = getLS("products", []);
        
        // L·∫•y danh s√°ch danh m·ª•c duy nh·∫•t
        const categories = [...new Set(products.map(p => p.category).filter(c => c))];
        const categorySelect = document.getElementById('filterCategory');
        
        categorySelect.innerHTML = '<option value="">Danh m·ª•c</option>'; 

        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
        });
    }

    // H√†m ch√≠nh: L·ªçc v√† Render s·∫£n ph·∫©m
    function renderProducts(){
        let products = getLS("products", []);
        const wrap = document.getElementById("productList");

        // 1. L·∫•y gi√° tr·ªã l·ªçc
        const keyword = initialKeyword; 
        const category = document.getElementById('filterCategory').value;
        const target = document.getElementById('filterTarget').value;
        const minP = parseFloat(document.getElementById('minPrice').value) || 0;
        const maxP = parseFloat(document.getElementById('maxPrice').value) || Infinity;
        const sortBy = document.getElementById('filterSort').value;

        // 2. L·ªçc s·∫£n ph·∫©m
        let filteredProducts = products.filter(p => {
            const price = p.salePrice ?? p.price;
            const matchesKeyword = !keyword || 
                                   p.name.toLowerCase().includes(keyword.toLowerCase()) ||
                                   p.id.toLowerCase().includes(keyword.toLowerCase());
            const matchesCategory = !category || p.category === category;
            const matchesTarget = !target || p.target === target;
            const matchesPrice = price >= minP && price <= maxP;
            
            return matchesKeyword && matchesCategory && matchesTarget && matchesPrice;
        });

        // 3. S·∫Øp x·∫øp s·∫£n ph·∫©m
        if (sortBy === 'price_asc') {
            filteredProducts.sort((a, b) => (a.salePrice ?? a.price) - (b.salePrice ?? b.price));
        } else if (sortBy === 'price_desc') {
            filteredProducts.sort((a, b) => (b.salePrice ?? b.price) - (a.salePrice ?? a.price));
        }
        
        // 4. Render
        if (!filteredProducts.length) {
            wrap.innerHTML = `<div class="col-12"><div class="alert alert-warning text-center">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p v·ªõi ti√™u ch√≠ l·ªçc.</div></div>`;
            return;
        }

        wrap.innerHTML = filteredProducts.map(p => `
            <div class="col-md-3 col-sm-6">
                <div class="card product-card h-100">
                    <div class="img-wrap">
                        <img src="${p.img}" alt="${p.name}">
                    </div>
                    <div class="card-body text-center">
                        <h6 class="mb-1">${p.name}</h6>
                        <div class="product-price fw-bold">${PetShop.fmtVND(p.salePrice ?? p.price)}</div>

                        ${ showStock
                            ? `<div class="small text-muted">T·ªìn: ${p.stock}</div>`
                            : (p.stock<=0 ? `<div class="small text-danger">H·∫øt h√†ng</div>` : ``)
                        }
                        ${ showBuyPrice ? `<div class="small text-muted">Gi√° nh·∫≠p: ${PetShop.fmtVND(p.buyPrice||0)}</div>` : ``}

                        <button class="btn btn-sm mt-2" ${p.stock<=0?'disabled':''}
                          onclick="PetShop.addToCart('${p.id}',1)" 
                          style="background:var(--primary-color); color:white;">Th√™m v√†o gi·ªè</button>
                    </div>
                </div>
            </div>
        `).join("");
    }
</script>
</body>
</html>